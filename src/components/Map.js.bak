import React, { useEffect, useState, useCallback, useRef } from 'react';
import { 
  GoogleMap, 
  useLoadScript, 
  Marker, 
  InfoWindow, 
  DirectionsRenderer,
  Circle,
  TrafficLayer
} from '@react-google-maps/api';
import { 
  MapPin, 
  Star, 
  Phone, 
  Navigation, 
  AlertTriangle,
  Clock,
  Car,
  Stethoscope,
  Heart,
  Building2
} from 'lucide-react';
import { collection, getDocs, query, where, onSnapshot, GeoPoint } from 'firebase/firestore';
import { db } from '../firebase';

// Define the libraries we need
const libraries = ['places', 'geometry', 'directions'];

const mapContainerStyle = {
  width: '100%',
  height: '500px',
  borderRadius: '0.75rem',
  position: 'relative',
  overflow: 'hidden'
};

const defaultCenter = {
  lat: 37.7749,
  lng: -122.4194
};

const mapOptions = {
  zoomControl: true,
  mapTypeControl: true,
  streetViewControl: true,
  fullscreenControl: true,
  mapTypeId: 'roadmap',
  styles: [
    {
      featureType: 'poi.medical',
      elementType: 'geometry',
      stylers: [{ visibility: 'on', color: '#f5d8d8' }]
    },
    {
      featureType: 'poi.medical',
      elementType: 'labels',
      stylers: [{ visibility: 'on', color: '#ef4444' }]
    },
    {
      featureType: 'road',
      elementType: 'geometry',
      stylers: [{ color: '#ffffff' }]
    },
    {
      featureType: 'road.arterial',
      elementType: 'labels',
      stylers: [{ visibility: 'on' }]
    },
    {
      featureType: 'transit.station.hospital',
      elementType: 'labels',
      stylers: [{ visibility: 'on', color: '#ef4444' }]
    }
  ]
};

// Emergency facility types for Places API
const emergencyPlaces = [
  'hospital',
  'doctor',
  'health',
  'pharmacy'
];

// Calculate distance between two points
const calculateDistance = (p1, p2) => {
  const R = 6371; // Earth's radius in km
  const dLat = (p2.lat - p1.lat) * Math.PI / 180;
  const dLon = (p2.lng - p1.lng) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return (R * c).toFixed(1); // Distance in km
};

const Map = ({ specialty = '', userLocation, isEmergency = false }) => {
  const [doctors, setDoctors] = useState([]);
  const [selectedDoctor, setSelectedDoctor] = useState(null);
  const [directions, setDirections] = useState(null);
  const [nearbyPlaces, setNearbyPlaces] = useState([]);
  const [searchRadius, setSearchRadius] = useState(isEmergency ? 5000 : 10000);
  const [loading, setLoading] = useState(false);
  const [showTraffic, setShowTraffic] = useState(isEmergency);
  const [routeInfo, setRouteInfo] = useState(null);

  const { isLoaded, loadError } = useLoadScript({
    googleMapsApiKey: "AIzaSyDnB2grsBTzb_19dCSKGWOJnTtNn984b-w",
    libraries: libraries
  });

  const mapRef = useRef(null);
  const placesService = useRef(null);
  const directionsService = useRef(null);
  const placesSessionToken = useRef(null);

  const onMapLoad = useCallback((map) => {
    mapRef.current = map;
    placesService.current = new window.google.maps.places.PlacesService(map);
    directionsService.current = new window.google.maps.DirectionsService();
    placesSessionToken.current = new window.google.maps.places.AutocompleteSessionToken();
  }, []);

  const getPlaceDetails = useCallback((placeId) => {
    return new Promise((resolve, reject) => {
      if (!placesService.current) return reject('Places service not initialized');

      placesService.current.getDetails(
        {
          placeId: placeId,
          fields: ['formatted_phone_number', 'opening_hours', 'website', 'photos', 'reviews'],
          sessionToken: placesSessionToken.current,
        },
        (place, status) => {
          if (status === window.google.maps.places.PlacesServiceStatus.OK) {
            resolve(place);
          } else {
            reject(status);
          }
        }
      );
    });
  }, []);

  const searchNearbyPlaces = useCallback(async () => {
    if (!placesService.current || !userLocation) return;

    const request = {
      location: new window.google.maps.LatLng(userLocation.lat, userLocation.lng),
      radius: searchRadius,
      type: isEmergency ? ['hospital'] : ['hospital', 'doctor', 'health'],
      keyword: specialty || 'doctor',
      rankBy: window.google.maps.places.RankBy.DISTANCE,
    };

    try {
      const results = await new Promise((resolve, reject) => {
        placesService.current.nearbySearch(request, (results, status) => {
          if (status === window.google.maps.places.PlacesServiceStatus.OK) {
            resolve(results);
          } else {
            reject(status);
          }
        });
      });

      const placesWithDetails = await Promise.all(
        results.map(async (place) => {
          try {
            const details = await getPlaceDetails(place.place_id);
            return {
              id: place.place_id,
              name: place.name,
              lat: place.geometry.location.lat(),
              lng: place.geometry.location.lng(),
              rating: place.rating,
              address: place.vicinity,
              isOpen: place.opening_hours?.isOpen(),
              phone: details.formatted_phone_number,
              website: details.website,
              photos: details.photos,
              reviews: details.reviews,
              distance: calculateDistance(userLocation, {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
              })
            };
          } catch (error) {
            console.error('Error fetching place details:', error);
            return null;
          }
        })
      );

      setNearbyPlaces(placesWithDetails.filter(place => place !== null));
    } catch (error) {
      console.error('Error searching nearby places:', error);
    }
  }, [userLocation, searchRadius, specialty, isEmergency, getPlaceDetails]);

  const getDirections = useCallback((destination) => {
    if (!directionsService.current || !userLocation) return;

    const request = {
      origin: new window.google.maps.LatLng(userLocation.lat, userLocation.lng),
      destination: new window.google.maps.LatLng(destination.lat, destination.lng),
      travelMode: 'DRIVING',
      optimizeWaypoints: true,
      provideRouteAlternatives: true,
      drivingOptions: {
        departureTime: new Date(),
        trafficModel: 'bestguess'
      }
    };

    directionsService.current.route(request, (result, status) => {
      if (status === 'OK') {
        setDirections(result);
        
        // Extract route information
        const route = result.routes[0];
        setRouteInfo({
          distance: route.legs[0].distance.text,
          duration: route.legs[0].duration.text,
          durationInTraffic: route.legs[0].duration_in_traffic?.text,
          steps: route.legs[0].steps
        });

        // If emergency, automatically show traffic layer
        if (isEmergency) {
          setShowTraffic(true);
        }
      }
    });
  }, [userLocation, isEmergency]);

  // Fetch data when component mounts or dependencies change
  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      try {
        // Fetch doctors from Firebase
        const doctorsRef = collection(db, 'doctors');
        const q = specialty 
          ? query(doctorsRef, where('specialty', '==', specialty))
          : doctorsRef;
        
        const snapshot = await getDocs(q);
        const doctorsList = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setDoctors(doctorsList);

        // If map is loaded, search for nearby places
        if (isLoaded && userLocation) {
          searchNearbyPlaces();
        }
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [specialty, isLoaded, userLocation, searchNearbyPlaces]);
  
  useEffect(() => {
    const fetchDoctors = async () => {
      try {
        const doctorsRef = collection(db, 'doctors');
        const q = specialty 
          ? query(doctorsRef, where('specialty', '==', specialty))
          : doctorsRef;
        
        const querySnapshot = await getDocs(q);
        const doctorsList = querySnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        setDoctors(doctorsList);
      } catch (error) {
        console.error('Error fetching doctors:', error);
      }
    };

    fetchDoctors();

    // Set up real-time updates
    const unsubscribe = onSnapshot(
      specialty 
        ? query(collection(db, 'doctors'), where('specialty', '==', specialty))
        : collection(db, 'doctors'),
      (snapshot) => {
        const doctorsList = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setDoctors(doctorsList);
      },
      (error) => {
        console.error('Error setting up real-time updates:', error);
      }
    );

    // Cleanup subscription
    return () => unsubscribe();
  }, [specialty]);

  return (
    <div className="bg-white rounded-xl shadow-lg p-6">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold">
          {isEmergency ? 'üö® Emergency Healthcare' : 'üó∫Ô∏è Nearby Healthcare Providers'}
        </h2>
        <div className="flex items-center space-x-4">
          <button
            onClick={() => setShowTraffic(!showTraffic)}
            className={`px-3 py-1 rounded-lg text-sm font-medium ${
              showTraffic 
                ? 'bg-blue-100 text-blue-600' 
                : 'bg-gray-100 text-gray-600'
            }`}
          >
            üöó Traffic
          </button>
          <select 
            value={searchRadius} 
            onChange={(e) => setSearchRadius(Number(e.target.value))}
            className="px-3 py-1 rounded-lg text-sm border border-gray-300"
          >
            <option value={2000}>2 km</option>
            <option value={5000}>5 km</option>
            <option value={10000}>10 km</option>
            <option value={20000}>20 km</option>
          </select>
        </div>
      </div>
      
      <div className="relative w-full h-[500px] bg-gray-100 rounded-xl overflow-hidden">
        {(!isLoaded || loading) ? (
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="flex flex-col items-center">
              <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
              <p className="mt-4 text-gray-600">Loading map...</p>
            </div>
          </div>
        ) : loadError ? (
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="text-red-500">Error loading maps</div>
          </div>
        ) : (
          <div className="absolute inset-0">
            <GoogleMap
              mapContainerStyle={{width: '100%', height: '100%'}}
              zoom={13}
              center={userLocation || defaultCenter}
              options={mapOptions}
              onLoad={onMapLoad}
            >
              {showTraffic && <TrafficLayer />}

              {userLocation && (
                <>
                  <Marker
                    position={userLocation}
                    icon={{
                      url: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMzQjgyRjYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIvPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiLz48L3N2Zz4=',
                      scaledSize: new window.google.maps.Size(30, 30)
                    }}
                  />
                  <Circle
                    center={userLocation}
                    radius={searchRadius}
                    options={{
                      fillColor: isEmergency ? '#FEE2E2' : '#DBEAFE',
                      fillOpacity: 0.2,
                      strokeColor: isEmergency ? '#EF4444' : '#3B82F6',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
                    }}
                  />
                </>
              )}
              
              {[...doctors, ...nearbyPlaces].map((location) => (
                <Marker
                  key={location.id}
                  position={{ lat: location.lat, lng: location.lng }}
                  onClick={() => setSelectedDoctor(location)}
                  icon={{
                    url: isEmergency 
                      ? 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNFRjQ0NDQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTggMmgtNmE0IDQgMCAwIDAtNCA0djE0YTMgMyAwIDAgMCAzIDNoNmEzIDMgMCAwIDAgMy0zVjRhMiAyIDAgMCAwLTItMnoiLz48bGluZSB4MT0iOSIgeTE9IjE0IiB4Mj0iMTUiIHkyPSIxNCIvPjxsaW5lIHgxPSIxMiIgeTE9IjE3IiB4Mj0iMTIiIHkyPSIxMSIvPjwvc3ZnPg==' 
                      : 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMzQjgyRjYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTggMmgtNmE0IDQgMCAwIDAtNCA0djE0YTMgMyAwIDAgMCAzIDNoNmEzIDMgMCAwIDAgMy0zVjRhMiAyIDAgMCAwLTItMnoiLz48bGluZSB4MT0iOSIgeTE9IjE0IiB4Mj0iMTUiIHkyPSIxNCIvPjxsaW5lIHgxPSIxMiIgeTE9IjE3IiB4Mj0iMTIiIHkyPSIxMSIvPjwvc3ZnPg==',
                    scaledSize: new window.google.maps.Size(30, 30)
                  }}
                />
              ))}

              {directions && <DirectionsRenderer directions={directions} />}

              {selectedDoctor && (
                <InfoWindow
                  position={{ lat: selectedDoctor.lat, lng: selectedDoctor.lng }}
                  onCloseClick={() => {
                    setSelectedDoctor(null);
                    setDirections(null);
                    setRouteInfo(null);
                  }}
                >
                  <div className="p-3 max-w-xs">
                    <h3 className="font-bold text-lg mb-1">{selectedDoctor.name}</h3>
                    <p className="text-blue-600 font-medium mb-2">
                      {selectedDoctor.specialty || selectedDoctor.types?.join(', ')}
                    </p>
                    
                    <div className="space-y-2 mb-3">
                      {selectedDoctor.rating && (
                        <div className="flex items-center space-x-1 text-sm text-gray-600">
                          <Star className="w-4 h-4 text-yellow-400 fill-current" />
                          <span>{selectedDoctor.rating}</span>
                        </div>
                      )}
                      
                      <div className="flex items-center space-x-1 text-sm text-gray-600">
                        <Navigation className="w-4 h-4" />
                        <span>{selectedDoctor.distance} km away</span>
                      </div>

                      {selectedDoctor.isOpen !== undefined && (
                        <div className="flex items-center space-x-1 text-sm text-gray-600">
                          <Clock className="w-4 h-4" />
                          <span className={selectedDoctor.isOpen ? 'text-green-600' : 'text-red-600'}>
                            {selectedDoctor.isOpen ? 'Open now' : 'Closed'}
                          </span>
                        </div>
                      )}

                      {selectedDoctor.address && (
                        <p className="text-sm text-gray-600 mt-1">{selectedDoctor.address}</p>
                      )}
                    </div>

                    <div className="space-y-2">
                      {selectedDoctor.phone && (
                        <button 
                          onClick={() => window.open(`tel:${selectedDoctor.phone}`, '_self')}
                          className="w-full py-2 px-3 bg-green-500 text-white rounded-lg flex items-center justify-center space-x-2 hover:bg-green-600 transition-colors"
                        >
                          <Phone className="w-4 h-4" />
                          <span>Call Now</span>
                        </button>
                      )}

                      <button 
                        onClick={() => getDirections(selectedDoctor)}
                        className="w-full py-2 px-3 bg-blue-500 text-white rounded-lg flex items-center justify-center space-x-2 hover:bg-blue-600 transition-colors"
                      >
                        <Car className="w-4 h-4" />
                        <span>Get Directions</span>
                      </button>

                      {routeInfo && (
                        <div className="mt-2 p-2 bg-gray-50 rounded-lg text-sm">
                          <p className="font-medium text-gray-900">Route Info:</p>
                          <p className="text-gray-600">Distance: {routeInfo.distance}</p>
                          <p className="text-gray-600">
                            Duration: {routeInfo.durationInTraffic || routeInfo.duration}
                          </p>
                        </div>
                      )}
                    </div>
                  </div>
                </InfoWindow>
              )}
            </GoogleMap>
          </div>
        )}
      </div>

      {isEmergency && (
        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div className="flex items-start space-x-2">
            <AlertTriangle className="w-5 h-5 text-red-500 mt-0.5" />
            <div>
              <h4 className="font-semibold text-red-700">Emergency Services</h4>
              <p className="text-sm text-red-600">
                Showing nearest emergency facilities within {searchRadius/1000}km radius.
                Call emergency services at 911 if immediate assistance is needed.
              </p>
            </div>
          </div>
        </div>
      )}

      {doctors.length > 0 && (
        <div className="mt-4">
          <p className="text-sm font-semibold mb-2">Showing {doctors.length} doctors:</p>
          <div className="space-y-2">
            {doctors.map(doctor => (
              <div key={doctor.id} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                <div>
                  <p className="font-medium">{doctor.name}</p>
                  <p className="text-sm text-gray-600">{doctor.distance}</p>
                </div>
                <button 
                  onClick={() => {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${doctor.lat},${doctor.lng}`, '_blank');
                  }}
                  className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"
                >
                  <MapPin className="w-5 h-5" />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

export default Map;